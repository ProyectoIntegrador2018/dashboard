<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <link rel="apple-touch-icon" sizes="76x76" href="../img/favicon.ico">
  <link rel="icon" type="image/ico" href="../img/favicon.ico">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>
    Dashboard de Monitoreo Automático | Ternium
  </title>
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet" />
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
  <!-- CSS Files -->
  <link href="../css/bootstrap.min.css" rel="stylesheet" />
  <link href="../css/paper-dashboard.css?v=2.0.1" rel="stylesheet" />
  <!-- CSS Just for demo purpose, don't include it in your project -->
  <link href="../assets/demo/demo.css" rel="stylesheet" />
</head>



<body class="">
  <div class="wrapper ">
    <div class="sidebar" data-color="white" data-active-color="danger">
      <div class="logo">
        <a href="https://mx.ternium.com/es" class="simple-text logo-normal">
          <div class="logo-image-big">
            <img src="../img/Ternium-Logo.png">
          </div>
        </a>
      </div>
      <div class="sidebar-wrapper">
        <ul class="nav">
          <li class="active">
            <a href='https://dashboard-tenium.herokuapp.com/dashboard'>
              <i class="nc-icon nc-bank"></i>
              <p>Dashboard</p>
            </a>
          </li>
          <li>
            <a href='https://dashboard-tenium.herokuapp.com/fallas'>
              <i class="nc-icon nc-settings"></i>
              <p>Fallas</p>
            </a>
          </li>
          <!-- Aqui esta comentado futuras tabs en caso de ser necesarias
          <li>
            <a href="https://dashboard-tenium.herokuapp.com/tablelist">
              <i class="nc-icon nc-tile-56"></i>
              <p>Table List</p>
            </a>
          </li>
          <li>
            <a href="https://dashboard-tenium.herokuapp.com/notifications">
              <i class="nc-icon nc-bell-55"></i>
              <p>Notifications</p>
            </a>
          </li>
          <li> -->
        </ul>
      </div>
    </div>
    <div class="main-panel">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-absolute fixed-top navbar-transparent">
        <div class="container-fluid">
          <div class="navbar-wrapper">
            <div class="navbar-toggle">
              <button type="button" class="navbar-toggler">
                <span class="navbar-toggler-bar bar1"></span>
                <span class="navbar-toggler-bar bar2"></span>
                <span class="navbar-toggler-bar bar3"></span>
              </button>
            </div>
            <a class="navbar-brand" href="javascript:;">Dashboard de Monitoreo Automático</a>
          </div>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-bar navbar-kebab"></span>
            <span class="navbar-toggler-bar navbar-kebab"></span>
            <span class="navbar-toggler-bar navbar-kebab"></span>
          </button>
          <div class="collapse navbar-collapse justify-content-end" id="navigation">
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link btn-magnify" href="javascript:;">
                  <i class="nc-icon nc-layout-11"></i>
                  <p>
                    <span class="d-lg-none d-md-block">Stats</span>
                  </p>
                </a>
              </li>
              <li class="nav-item btn-rotate dropdown">
                <a class="nav-link dropdown-toggle" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="nc-icon nc-bell-55"></i>
                  <p>
                    <span class="d-lg-none d-md-block">Some Actions</span>
                  </p>
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                  <a class="dropdown-item" href="#">Action</a>
                  <a class="dropdown-item" href="#">Another action</a>
                  <a class="dropdown-item" href="#">Something else here</a>
                </div>
              </li>
              <li class="nav-item">
                <a class="nav-link btn-rotate" href="javascript:;">
                  <i class="nc-icon nc-settings-gear-65"></i>
                  <p>
                    <span class="d-lg-none d-md-block">Account</span>
                  </p>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <!-- End Navbar -->
      <div class="content">
        <div class="row">
          <div class="col-lg-4 col-md-6 col-sm-6">
            <div class="card card-stats">
              <div class="card-body ">
                <div class="row">
                  <div class="col-5 col-md-4">
                    <div class="icon-big text-center icon-warning">
                      <i class="nc-icon nc-vector text-danger"></i>
                    </div>
                  </div>
                  <div class="col-7 col-md-8">
                    <div class="numbers">
                      <p class="card-category">Errores</p>
                      <p class="card-title">23<p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-footer ">
                <hr>
                <div class="stats">
                  <i class="fa fa-clock-o"></i>
                  En la última hora
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4 col-md-6 col-sm-6">
            <div class="card card-stats">
              <div class="card-body ">
                <div class="row">
                  <div class="col-5 col-md-4">
                    <div class="icon-big text-center icon-warning">
                      <i class="nc-icon nc-time-alarm text-warning"></i>
                    </div>
                  </div>
                  <div class="col-7 col-md-8">
                    <div class="numbers">
                      <p class="card-category">Última Detección</p>
                      <p class="card-title">25/05/2020<p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-footer ">
                <hr>
                <div class="stats">
                  <i class="fa fa-refresh"></i>
                  Recientemente actualizado
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4 col-md-6 col-sm-6">
            <div class="card card-stats">
              <div class="card-body ">
                <div class="row">
                  <div class="col-5 col-md-4">
                    <div class="icon-big text-center icon-warning">
                      <i class="nc-icon nc-settings text-danger"></i>
                    </div>
                  </div>
                  <div class="col-7 col-md-8">
                    <div class="numbers">
                      <p class="card-category">Última Anomalía</p>
                      <p class="card-title">Operación<p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-footer ">
                <hr>
                <div class="stats">
                  <i class="fa fa-refresh"></i>
                  Recientemente actualizado
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <div class="card ">
              <div class="card-header ">
                <h5 class="card-title">Fallas por Mes</h5>
              </div>
              <div class="card-body ">
                <figure class="highcharts-figure">
                  <div id="stackedArea"></div>
                </figure>              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <div class="card ">
              <div class="card-header ">
                <h5 class="card-title">Cantidad de Fallas por Área</h5>
              </div>
              <div class="card-body ">
                <figure class="highcharts-figure">
                  <div id="tree"></div>
                </figure>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <div class="card card-chart">
              <div class="card-header">
                <h5 class="card-title">Tiempo de Demora Promedio por Área</h5>
              </div>
              <div class="card-body">
                <figure class="highcharts-figure">
                  <div id="stackedBar"></div>
                </figure>
              </div>
            </div>
          </div>
        </div>
      </div>
      <footer class="footer footer-black  footer-white ">
        <div class="container-fluid">
          <div class="row">
            <nav class="footer-nav">
              <ul>
              </ul>
            </nav>
            <div class="credits ml-auto">
              <span class="copyright">
                © <script>
                  document.write(new Date().getFullYear())
                </script>, hecho con<i class="fa fa-heart heart"></i> por Gallos de Oro
              </span>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </div>
  <!--   Core JS Files   -->
  <script src="../js/core/jquery.min.js"></script>
  <script src="../js/core/popper.min.js"></script>
  <script src="../js/core/bootstrap.min.js"></script>
  <script src="../js/plugins/perfect-scrollbar.jquery.min.js"></script>
  <!--  Google Maps Plugin    -->
  <!--script src="https://maps.googleapis.com/maps/api/js?key=YOUR_KEY_HERE"></script>
  <!-- Chart JS -->
  <script src="../js/plugins/chartjs.min.js"></script>
  <!--  Notifications Plugin    -->
  <script src="../js/plugins/bootstrap-notify.js"></script>
  <!-- Control Center for Now Ui Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="../js/paper-dashboard.min.js?v=2.0.1" type="text/javascript"></script><!-- Paper Dashboard DEMO methods, don't include it in your project! -->
  <script src="../demo/demo.js"></script>
  <script>
  //Se tiene un array de colores que se irán asignando conforme vayan llegando las fallas de la base de datos
  var colores = ["#4A79A7","#F28E2B","#E15759","#76B7C2","#59A14F","#EDC948","#B07AA1"]

  //Para asegurarse que la información se encuentra lista para cargar a las gráficas se usó un promise el cual
  //espera que se haga el fetch de la base de datos correctamente antes de accesar a la información y usarla
  function getData() {
    return new Promise((resolve, reject) =>{
      var acum = []
      $.ajax({
        //Se busca la información regresada por la query de la base de datos en la ruta descrita abajo
        contentType: "application/json",
        url: "/readDataFromDB",

        //En caso de accesar a la información correctamente, esta se añade a un array
        //La estructura del objeto que se usará para llenar las gráficas será un array
        //en donde cada posición representa una query hecha en server.js. Si se quieren
        //agregar más entradas (queries) se deben añadir más entradas ajax con el .then
        //para confirmar y asegurarse que dichas entradas se encuentran en orden en el array
        success: function(result) {
          //const json = result.body
          //console.log(result)
          acum.push(result)
        },
        error: function(error){
          console.log("Error")
          reject(error)
        }
      }).then(function(result){
        $.ajax({
          contentType: "application/json",
          url: "/readDataFromDBVars",

          success: function(resultado) {
            //const json = result.body
            acum.push(resultado)
            resolve(acum)
          },
          error: function(error){
            console.log("Error")
            reject(error)
          }
        });
    });
  }).then(function(result){
      console.log("Termino el promise")
      return result
  });
  }

  //En esta función se encuentra toda la lógica del manejo de la información de la base de datos para
  //ajustar esa información a un formato aceptado por highcharts
  async function loadDataDB(cb) {
    var series = []
    var seriesTree = []
    var seriesBars = []

    console.log("LoadDataDB")
    //Se espera que la información esté lista del fetch
    getData().then(function(result,error){
      //result.sort()
      //console.log(result)

      //Se tiene un diccionario para cada gráfica en la pantalla de resumen
      var dict = {
      }

      var dictTree = {
      }

      var dictBars = {
      }

      //Se puede apreciar un ejemplo de la información dentro del array de queries
      console.log("resultado[0]:")
      console.log(result[0])
      console.log("resultado[1]")
      console.log(result[1])

      //La estructura para los highcharts es un arreglo de series (dependiendo del tipo de gráfica), en general se tiene un arreglo de diccionarios
      //donde se tienen 3 atributos, name:string, data:array de enteros, color:string.
      //Para la primera gráfica (es mejor correr el proyecto para ver las gráficas y entender los datos) se tiene la siguiente lógica:
      //Si la falla no se encuentra en el diccionario, se añade manualmente con la información de la query. (Nótese que esta primera query
      //agrupa los datos por tipo de falla excluyendo el campo variable y los ordena por año, mes y nombre)
      for (var i = 0; i < result[0].length; i++){
        if (!(result[0][i]._id.fallas in dict)){
          dict[result[0][i]._id.fallas] = {name:result[0][i]._id.fallas, data:[], color:colores[Object.keys(dict).length]}
        }
        dict[result[0][i]._id.fallas].data.push(result[0][i].count)
      }

      //Para la segunda gráfica, se tiene la misma estructura que la primera, sólo que se tiene un acumulado de las fallas para seguir
      //el input esperado de la gráfica de tree
      for (var i = 0; i < result[0].length; i++){
        if (!(result[0][i]._id.fallas in dictTree)){
          dictTree[result[0][i]._id.fallas] = {name:result[0][i]._id.fallas, value:0, color:colores[Object.keys(dictTree).length]}
        }
        dictTree[result[0][i]._id.fallas].value += result[0][i].count
      }

      //Esta es sin duda la gráfica más compleja de programar. Para la gráfica de barras es necesario dividir cada variable por su falla.
      //Ej. {var1, falla1}, {var2, falla2}, {var3,falla1} => {falla1:[var1,var3]},{falla2:[var2]}
      //Sabemos que la query no agrupa las variables por falla, por lo tanto debemos de hacer eso manualmente. Además, como pueden existir
      //múltiples entradas de la misma variable porque se dividen por mes, de tiene que mantener un acumulado de esa varibale en esa falla en específico.
      for(var i = 0; i<result[1].length; i++){
        //Si no se ha encontrado esta falla, se agrega al diccionario
        if(!(result[1][i]._id.fallas in dictBars)){
          dictBars[result[1][i]._id.fallas] = {name:result[1][i]._id.fallas, variable:[{nameVariable:result[1][i]._id.variable, data:result[1][i].count}], color:colores[Object.keys(dictBars).length]}
        }
        var cambio = false
        for(var j = 0; j<dictBars[result[1][i]._id.fallas].variable.length; j++){
          //Si ya se encontró la variable, se acumula su valor con el ya existente
          if(dictBars[result[1][i]._id.fallas].variable[j].nameVariable == result[1][i]._id.variable){
            dictBars[result[1][i]._id.fallas].variable[j].data += result[1][i].count
            cambio = true
            break;
          }
        }
        if(!cambio){
          //Si no se ha añadido la variable se añade manualmente
          dictBars[result[1][i]._id.fallas].variable.push({nameVariable:result[1][i]._id.variable, data:result[1][i].count})
        }
      }
      console.log(dictBars)

      //Existe un problema grave para la primera gráfica, el cual es que dado que no todos los arreglos tienen la misma
      //cantidad de entradas, la información a partir de cierto punto se mezcla y se pierde el sentido de la gráfica. Por ahora
      //no hemos implementado la lógica para identificar el mes para el cual la falla no tiene informaicón, pero lo correcto sería
      //añadir en todos esos meses en los que no se tiene información para un tipo de falla en específico, se agrega un 0 para no
      //alterar la información de la gráfica
      dict["Servicios Centrales"].data.push(20)
      dict["Servicios Centrales"].data.push(20)
      dict["Servicios Centrales"].data.push(20)

      dict["Ing Sistemas"].data.push(20)
      dict["Ing Sistemas"].data.push(20)
      dict["Ing Sistemas"].data.push(20)
      dict["Ing Sistemas"].data.push(20)

      for (var key in dict){
        series.push(dict[key])
      }
      for (var key in dictTree){
        seriesTree.push(dictTree[key])
      }

      var cont = 0
      var tempArray = []

      //La estructura de las gráficas de barras es la siguiente:
      //Para cada falla, se tiene un arreglo de variables. Para identificar una falla de otra, se tiene un 0 en el array de data por
      //cada columna antes de la columna actual. En otras palabras, cada falla va a tener 0s apendeados dependiendo de su índice.
      //Ej: falla1:[1,2,3], falla2[4,5,6], falla3:[7,8,9]
      //series[tempArray[1],tempArray[2],tempArray[3],
      //       tempArray[0,4],tempArray[0,5],tempArray[0,6],
      //       tempArray[0,0,7],tempArray[0,0,8],tempArray[0,0,9]]
      for(var key in dictBars){
        for(var i = 0; i<dictBars[key].variable.length; i++){
          tempArray = [];
          for(var j = 0; j<cont; j++){
            tempArray.push(0)
          }
          tempArray.push(dictBars[key].variable[i].data)
          seriesBars.push({name:dictBars[key].name, color:dictBars[key].color, data: tempArray})
        }

        cont += 1
      }

      console.log(seriesBars)
      //Se regresa un callback para corregir bug de disponibilidad de los datos antes de cargar gráficas
      return cb(null, series,seriesTree,seriesBars)
    }, function(error){
       cb(error)
    });

    console.log("Finished Fetching")
  }

  </script>
  <!-- Highcharts Dependencies -->
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/treemap.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/accessibility.js"></script>
  <!-- Highcharts Code -->
  <script>

  $(document).ready(function() {
    //Se llena toda la información necesaria para Highcharts. Si se quiere modificar las categorías, se podría crear manualmente un arreglo
    //en donde para cada tipo de falla diferente que exista (o por mes, o alguna otra), se agrega una nueva categoría, por ahora está harcodeado.
    loadDataDB(function(error,series,seriesTree,seriesBars){
      if(error){
        console.log("Error")
      }
    //Stacked Bar Chart
    Highcharts.chart('stackedBar', {
      chart: {
        type: 'column'
      },
      title: {
        text: ''
      },
      xAxis: {
        categories: ['Fallas Electricas', 'Fallas Mecanicas', 'Ing Sistemas', 'Preparacion Equipos', 'Propias de Operación', 'Servicios Centrales', 'Servicios Operación']
      },
      yAxis: {
        min: 0,
        title: {
          text: 'Minutos'
        },
        stackLabels: {
          enabled: true,
          style: {
            fontWeight: 'bold',
            color: ( // theme
              Highcharts.defaultOptions.title.style &&
              Highcharts.defaultOptions.title.style.color
            ) || 'gray'
          }
        }
      },
      legend: {
        backgroundColor:
          Highcharts.defaultOptions.legend.backgroundColor || 'white',
        shadow: false
      },
      tooltip: {
        headerFormat: '<b>{point.x}</b><br/>',
        pointFormat: '{series.name}: {point.y}<br/>Total: {point.stackTotal}'
      },
      plotOptions: {
        column: {
          stacking: 'normal',
          dataLabels: {
            enabled: true
          }
        }
      },
      series: seriesBars
    });

    // Stacked Area Chart
    Highcharts.chart('stackedArea', {
    chart: {
      type: 'area'
    },
    title: {
      text: ''
    },
    subtitle: {
      text: ''
    },
    xAxis: {
      categories: ['Junio 2019','Julio 2019', 'Agosto 2019', 'Septiembre 2019', 'Octubre 2019', 'Noviembre 2019', 'Diciembre 2019', 'Enero 2020', 'Febrero 2020', 'Marzo 2020', 'Abril 2020', 'Mayo 2020', 'Junio 2020'],
      tickmarkPlacement: 'on',
      title: {
        enabled: false
      }
    },
    yAxis: {
      title: {
        text: 'Fallas'
      },
      labels: {
        formatter: function () {
          return this.value;
        }
      }
    },
    tooltip: {
      split: true,
      valueSuffix: ''
    },
    plotOptions: {
      area: {
        stacking: 'normal',
        lineColor: '#666666',
        lineWidth: 1,
        marker: {
          lineWidth: 1,
          lineColor: '#666666'
        }
      }
    },
    series: series
    });
    //Tree chart
    Highcharts.chart('tree', {
    series: [{
      type: "treemap",
      layoutAlgorithm: 'stripes',
      alternateStartingDirection: true,
      levels: [{
        level: 1,
        layoutAlgorithm: 'sliceAndDice',
        dataLabels: {
          enabled: true,
          align: 'left',
          verticalAlign: 'top',
          style: {
            fontSize: '15px',
            fontWeight: 'bold'
          }
        }
      }],
      data: seriesTree
    }],
    title: {
      text: ''
    }
  });
  demo.initChartsPages();
  });
  });


  </script>



</body>

</html>
